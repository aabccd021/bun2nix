{ pkgs }:
let
  lib = pkgs.lib;
  extract =
    src:
    pkgs.runCommand "extracted-${src.name}" { } ''
      mkdir -p "$out"
      ${pkgs.libarchive}/bin/bsdtar \
        --extract \
        --file "${src}" \
        --directory "$out" \
        --strip-components=1 \
        --no-same-owner \
        --no-same-permissions
      chmod -R a+X "$out"
    '';
  packages = {
    "@types/bun" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/@types/bun/-/bun-1.2.21.tgz";
        hash = "sha512-NiDnvEqmbfQ6dmZ3EeUO577s4P5bf4HCTXtI6trMc6f6RzirY5IrF3aIookuSpyslFzrnvv2lmEWv5HyC1X79A==";
      }
    );
    "@types/node" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/@types/node/-/node-24.3.0.tgz";
        hash = "sha512-aPTXCrfwnDLj4VvXrm+UUCQjNEvJgNA8s5F1cvwQU+3KNltTOkBm1j30uNLyqqPNe7gE3KFzImYoZEfLhp4Yow==";
      }
    );
    "@types/react" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/@types/react/-/react-19.1.12.tgz";
        hash = "sha512-cMoR+FoAf/Jyq6+Df2/Z41jISvGZZ2eTlnsaJRptmZ76Caldwy1odD4xTr/gNV9VLj0AWgg/nmkevIyUfIIq5w==";
      }
    );
    "bun-types" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/bun-types/-/bun-types-1.2.21.tgz";
        hash = "sha512-sa2Tj77Ijc/NTLS0/Odjq/qngmEPZfbfnOERi0KRUYhT9R8M4VBioWVmMWE5GrYbKMc+5lVybXygLdibHaqVqw==";
      }
    );
    "csstype" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/csstype/-/csstype-3.1.3.tgz";
        hash = "sha512-M1uQkMl8rQK/szD0LNhtqxIPLpimGm8sOBwU7lLnCpSbTyY3yeU1Vc7l4KT5zT4s/yOxHH5O7tIuuLOCnLADRw==";
      }
    );
    "is-buffer" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-buffer/-/is-buffer-1.1.6.tgz";
        hash = "sha512-NcdALwpXkTm5Zvvbk7owOUSvVvBKDgKP5/ewfXEznmQFfs4ZRmanOeKBTjRVjka3QFoN6XJ+9F3USqfHqTaU5w==";
      }
    );
    "is-even" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-even/-/is-even-1.0.0.tgz";
        hash = "sha512-LEhnkAdJqic4Dbqn58A0y52IXoHWlsueqQkKfMfdEnIYG8A1sm/GHidKkS6yvXlMoRrkM34csHnXQtOqcb+Jzg==";
      }
    );
    "is-number" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-number/-/is-number-3.0.0.tgz";
        hash = "sha512-4cboCqIpliH+mAvFNegjZQ4kgKc3ZUhQVr3HvWbSh5q3WH2v82ct+T2Y1hdU5Gdtorx/cLifQjqCbL7bpznLTg==";
      }
    );
    "is-odd" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-odd/-/is-odd-0.1.2.tgz";
        hash = "sha512-Ri7C2K7o5IrUU9UEI8losXJCCD/UtsaIrkR5sxIcFg4xQ9cRJXlWA5DQvTE0yDc0krvSNLsRGXN11UPS6KyfBw==";
      }
    );
    "kind-of" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/kind-of/-/kind-of-3.2.2.tgz";
        hash = "sha512-NOW9QQXMoZGg/oqnVNoNTTIFEIid1627WCffUBJEdMxYApq7mNE7CpzucIPc+ZQg25Phej7IJSmX3hO+oblOtQ==";
      }
    );
    "lodash" = pkgs.fetchgit {
      url = "https://github.com/lodash/lodash";
      rev = "8a26eb4";
      hash = "sha512-vnPywqoW9XktfDGl2BWRhzI2mDZPL4yNWnwo8MD3x4u6EU6Q8223X8tKgZz2EtnzYOfUpKKizv2ZbovHg047jg==";
    };
    "undici-types" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/undici-types/-/undici-types-7.10.0.tgz";
        hash = "sha512-t5Fy/nfn+14LuOc2KNYg75vZqClpAiqscVvMygNnlsHBFpSXdJaYtXMcdNLpl/Qvc3P2cB3s6lOV51nqsFq4ag==";
      }
    );
  };
  mergePackages = lib.pipe packages [
    (lib.mapAttrsToList (
      name: pkg: ''
        mkdir -p "$out/${name}"
        cp -Lr ${pkg}/* "$out/${name}"
      ''
    ))
    (lib.concatStringsSep "\n")
  ];
in
pkgs.runCommand "node_modules" { } ''
  mkdir -p "$out"
  ${mergePackages}
''
