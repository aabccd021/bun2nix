{ pkgs }:
let
  lib = pkgs.lib;
  extract =
    src:
    pkgs.runCommand "extracted-${src.name}" { } ''
      mkdir -p "$out"
      ${pkgs.libarchive}/bin/bsdtar \
        --extract \
        --file "${src}" \
        --directory "$out" \
        --strip-components=1 \
        --no-same-owner \
        --no-same-permissions
      chmod -R a+X "$out"
    '';
  packages = {
    "jsonc-parser" = extract (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/jsonc-parser/-/jsonc-parser-3.3.1.tgz";
        hash = "sha512-HUgH65KyejrUFPvHFPbqOY0rsFip3Bo5wb4ngvdi1EpCYWUQDC5V+Y7mZws+DLkr4M//zQJoanu1SP+87Dv1oQ==";
      }
    );
  };
  mergePackages = lib.pipe packages [
    (lib.mapAttrsToList (
      name: pkg: ''
        mkdir -p "$out/${name}"
        cp -Lr ${pkg}/* "$out/${name}"
      ''
    ))
    (lib.concatStringsSep "\n")
  ];
in
pkgs.runCommand "node_modules" { } ''
  mkdir -p "$out"
  ${mergePackages}
''
