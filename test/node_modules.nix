{ pkgs }:
let
  extractTo =
    out_path: src:
    pkgs.runCommand "node_modules-${out_path}" { } ''
      mkdir -p $out/${out_path}
      ${pkgs.libarchive}/bin/bsdtar \
        --extract \
        --file "${src}" \
        --directory $out/${out_path} \
        --strip-components=1 \
        --no-same-owner \
        --no-same-permissions
      chmod -R a+X $out/${out_path}
    '';
  copyTo =
    out_path: src:
    pkgs.runCommand "node_modules-${out_path}" { } ''
      mkdir -p $out
      cp -Lr ${src}/ $out/${out_path}
    '';
in
pkgs.symlinkJoin {
  name = "node_modules";
  paths = [
    (extractTo "is-buffer" (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-buffer/-/is-buffer-1.1.6.tgz";
        hash = "sha512-NcdALwpXkTm5Zvvbk7owOUSvVvBKDgKP5/ewfXEznmQFfs4ZRmanOeKBTjRVjka3QFoN6XJ+9F3USqfHqTaU5w==";
      }
    ))
    (extractTo "is-even" (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-even/-/is-even-1.0.0.tgz";
        hash = "sha512-LEhnkAdJqic4Dbqn58A0y52IXoHWlsueqQkKfMfdEnIYG8A1sm/GHidKkS6yvXlMoRrkM34csHnXQtOqcb+Jzg==";
      }
    ))
    (extractTo "is-number" (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-number/-/is-number-3.0.0.tgz";
        hash = "sha512-4cboCqIpliH+mAvFNegjZQ4kgKc3ZUhQVr3HvWbSh5q3WH2v82ct+T2Y1hdU5Gdtorx/cLifQjqCbL7bpznLTg==";
      }
    ))
    (extractTo "is-odd" (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/is-odd/-/is-odd-0.1.2.tgz";
        hash = "sha512-Ri7C2K7o5IrUU9UEI8losXJCCD/UtsaIrkR5sxIcFg4xQ9cRJXlWA5DQvTE0yDc0krvSNLsRGXN11UPS6KyfBw==";
      }
    ))
    (extractTo "kind-of" (
      pkgs.fetchurl {
        url = "https://registry.npmjs.org/kind-of/-/kind-of-3.2.2.tgz";
        hash = "sha512-NOW9QQXMoZGg/oqnVNoNTTIFEIid1627WCffUBJEdMxYApq7mNE7CpzucIPc+ZQg25Phej7IJSmX3hO+oblOtQ==";
      }
    ))
    (copyTo "lodash" (
      pkgs.fetchgit {
        url = "https://github.com/lodash/lodash";
        rev = "8a26eb4";
        hash = "sha512-vnPywqoW9XktfDGl2BWRhzI2mDZPL4yNWnwo8MD3x4u6EU6Q8223X8tKgZz2EtnzYOfUpKKizv2ZbovHg047jg==";
      }
    ))
  ];
}
